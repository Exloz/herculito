rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isValidString(value, maxLength) {
      return value is string && value.size() > 0 && value.size() <= maxLength;
    }

    function isValidExerciseTemplate() {
      // Backwards-compatible schema:
      // - Older app versions use `category`
      // - Newer/stricter schema may use `muscleGroup`
      // - `description` is optional
      return request.resource.data.keys().hasAll(['name', 'createdBy', 'isPublic', 'sets', 'reps'])
        && isValidString(request.resource.data.name, 100)
        && isValidString(request.resource.data.createdBy, 128)
        && request.resource.data.isPublic is bool
        && (
          ('muscleGroup' in request.resource.data && isValidString(request.resource.data.muscleGroup, 50))
          || ('category' in request.resource.data && isValidString(request.resource.data.category, 50))
        )
        && (!('description' in request.resource.data) || request.resource.data.description is string && request.resource.data.description.size() <= 500)
        && request.resource.data.sets is number
        && request.resource.data.reps is number
        && request.resource.data.sets >= 1 && request.resource.data.sets <= 20
        && request.resource.data.reps >= 1 && request.resource.data.reps <= 100
        && (!('restTime' in request.resource.data) || request.resource.data.restTime is number && request.resource.data.restTime >= 0 && request.resource.data.restTime <= 3600)
        && (!('timesUsed' in request.resource.data) || request.resource.data.timesUsed is number && request.resource.data.timesUsed >= 0);
    }

    match /routines/{routineId} {
      allow read: if isAuthenticated()
        && (
          resource.data.isPublic == true
          || !('isPublic' in resource.data)
          || isOwner(resource.data.createdBy)
          || isOwner(resource.data.userId)
        );

      allow create: if isAuthenticated()
        && (isOwner(request.resource.data.createdBy) || isOwner(request.resource.data.userId))
        && request.resource.data.name.size() <= 100
        && request.resource.data.exercises.size() <= 50;

      allow update: if isAuthenticated()
        && (
          isOwner(resource.data.createdBy)
          || isOwner(resource.data.userId)
        )
        && request.resource.data.name.size() <= 100;

      allow delete: if isAuthenticated()
        && (isOwner(resource.data.createdBy) || isOwner(resource.data.userId));

      // Allow community usage counter increments without requiring ownership.
      // NOTE: must compare request.resource.data with resource.data (not resource.data with itself).
      allow update: if isAuthenticated()
        && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['timesUsed'])
        && (request.resource.data.timesUsed is number)
        && (
          (
            resource.data.timesUsed is number
            && request.resource.data.timesUsed == resource.data.timesUsed + 1
          )
          || (
            !('timesUsed' in resource.data)
            && request.resource.data.timesUsed == 1
          )
        );
    }

    match /userRoutines/{userRoutineId} {
      allow read, write: if isAuthenticated() && isOwner(resource.data.userId);
      allow create: if isAuthenticated() && isOwner(request.resource.data.userId);
    }

    match /workoutSessions/{sessionId} {
      allow read, write, delete: if isAuthenticated() && isOwner(resource.data.userId);
      allow create: if isAuthenticated() && isOwner(request.resource.data.userId)
        && request.resource.data.exercises.size() <= 100;
    }

    match /exerciseHistory/{historyId} {
      allow read, write, delete: if isAuthenticated() && isOwner(resource.data.userId);
      allow create: if isAuthenticated() && isOwner(request.resource.data.userId);
    }

    match /exerciseLogs/{logId} {
      allow read, write, delete: if isAuthenticated() && isOwner(resource.data.userId);
      allow create: if isAuthenticated() && isOwner(request.resource.data.userId)
        && request.resource.data.sets.size() <= 20;
    }

    match /exerciseTemplates/{templateId} {
      allow read: if isAuthenticated();

      allow create: if isAuthenticated()
        && isValidExerciseTemplate();

      allow update: if isAuthenticated()
        && (
          isOwner(resource.data.createdBy)
          || (
            !('createdBy' in resource.data)
            && isOwner(request.resource.data.createdBy)
          )
        )
        && isValidExerciseTemplate();

      // Allow usage counter increments without requiring ownership.
      allow update: if isAuthenticated()
        && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['timesUsed'])
        && (request.resource.data.timesUsed is number)
        && (
          (
            resource.data.timesUsed is number
            && request.resource.data.timesUsed == resource.data.timesUsed + 1
          )
          || (
            !('timesUsed' in resource.data)
            && request.resource.data.timesUsed == 1
          )
        );

      allow delete: if isAuthenticated()
        && (
          isOwner(resource.data.createdBy)
          || !('createdBy' in resource.data)
        );
    }

    match /workouts/{workoutId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && isOwner(resource.data.createdBy);
      allow create: if isAuthenticated() && isOwner(request.resource.data.createdBy);
    }
  }
}
